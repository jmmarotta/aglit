# Major Overhaul Plan

## Summary
Move AGLIT to a Markdown-first canonical store, remove session focus and edit tools, and simplify the SDK/CLI/plugin to only the minimal deep-module responsibilities: UUIDv7 ids, key allocation, header parsing, and list/board rendering. Agents will use default OpenCode tools (`bash`, `read`, `write`, `edit`) to work directly with issue and project files.

## Guiding Principles
- North star: "A Philosophy of Software Design" (deep modules, small/stable interfaces, avoid derived state as canonical, human-reviewable data).
- Inspiration: Linear (issues + projects, minimal workflow states, board/list as derived views).

## Goals
- Canonical state is human-readable Markdown with minimal, stable frontmatter.
- No session focus state, no touches, no tool-driven edits.
- SDK acts as the deep module for non-trivial logic (UUIDv7, key allocation, header parsing, rendering).
- CLI is thin and stable; encourages standard OpenCode tools.
- Project grouping is optional and derived by scanning issues; no derived state is canonical.

## Non-goals
- No timestamps (`createdAt`/`updatedAt`) stored in files.
- No JSON canonical store; no event logs.
- No migration command (`aglit migrate`) (breaking change; legacy JSON can remain but is ignored).
- No plugin-owned focus state or pointer file.
- No complex schema validation or heavy parsing of body sections.

## Canonical Storage Layout
```
.aglit/
  config.json
  issues/
    ISU-1.md
  projects/
    major-refactor.md
```

## File Formats

### Issues
Path: `.aglit/issues/<KEY>.md`

Required frontmatter keys:
- schema: `aglit.issue.md.v1`
- id: UUIDv7 (generated by SDK/CLI)
- status: `inbox|planned|active|blocked|done|canceled`
- priority: `none|low|medium|high`

Issue key comes from the filename (`<issuePrefix>-<n>.md`). `issuePrefix` is required and set via `aglit init --prefix` or `aglit new --prefix`.

Optional frontmatter keys:
- projectId: `<uuidv7>`

Project reference uses a stable `projectId` (UUIDv7). Project slugs live in filenames
under `.aglit/projects/<slug>.md` and can be renamed without touching issues.

Title: first H1 (`# `). If missing, default to key during rendering.

Recommended sections (convention only, not parsed):
- `## Description`
- `## Acceptance`
- `## Constraints`
- `## Plan`
- `## Verification`

Template written by CLI:
```
---
schema: aglit.issue.md.v1
id: <uuidv7>
status: inbox
priority: none
---

# <Title>

## Description

## Acceptance

## Constraints

## Plan

## Verification
```

### Projects
Path: `.aglit/projects/<slug>.md` (e.g. `.aglit/projects/major-refactor.md`)

Required frontmatter keys:
- schema: `aglit.project.md.v1`
- id: UUIDv7 (generated by SDK/CLI)
- status: `inbox|planned|active|blocked|done|canceled`
- priority: `none|low|medium|high`

Title: first H1 (`# `). If missing, default to key during rendering.

Recommended sections:
- `## Description`
- `## Scope`
- `## Milestones`
- `## Notes`

Template written by CLI:
```
---
schema: aglit.project.md.v1
id: <uuidv7>
status: inbox
priority: none
---

# <Title>

## Description

## Scope

## Milestones

## Notes
```

## Ordering and Views
- Ordering within a status group: priority (high -> none), then key number ascending.
- Board/list views are derived by scanning issue headers only.
- Project issue membership is derived by scanning issues with `projectId: <uuidv7>`.

## SDK Plan (Deep Module)
Replace JSON CRUD/ops with small, stable primitives:

Notes:
- Parse frontmatter by extracting the leading `---` block and using `Bun.YAML.parse`.
- Extract the title by stripping frontmatter and using `Bun.markdown.render` to capture the first H1.

### New/Updated Modules
- `uuid.ts`
  - `generateIssueId(): string` (UUIDv7 only)
  - Uses `Bun.randomUUIDv7()` if available; otherwise generates v7 with `crypto.randomBytes`.

- `frontmatter.ts`
  - Parse a simple `---` frontmatter block into `Record<string, string>`
  - Render frontmatter with stable ordering for CLI templates

- `headers.ts`
  - `parseIssueHeader(filePath, text)` -> `{ key, id?, status, priority, project?, title, path }`
  - `parseProjectHeader(filePath, text)` -> `{ key, id?, status, priority, title, path }`

- `list.ts`
  - `listIssueHeaders(rootDir, { status?, project?, limit? })`
  - `listProjectHeaders(rootDir, { status?, limit? })`

- `views.ts`
  - `getBoardView(rootDir, { status?, project?, limit? })`
  - `getProjectsView(rootDir, { status?, limit? })`
    - includes derived issue counts by scanning issues

- `render.ts`
  - `renderBoard(view)`
  - `renderList(headers)`
  - `renderProjects(view)`

- `create.ts`
  - `createIssueFile({ title, status?, priority?, projectId?, prefix? })`
  - `createProjectFile({ title, status?, priority?, slug? })`
  - Uses config prefix for issues; projects use slug filenames
  - Writes template Markdown files with UUIDv7 ids

### Remove
- JSON schema/ops/validation (`schema.ts`, `ops.ts`, `issues.ts` editing, `uid.ts` v4 fallback)
- `touches`, `review`, `notes`, `verification` schemas
- `next task` view (not needed; tasks live in Markdown sections)
- Locking is optional; keep only around key allocation + file write

## CLI Plan (Thin Wrapper)
Replace with minimal, stable commands:

- `aglit init --prefix ABC`
  - Ensures `.aglit/issues/` and `.aglit/projects/`
  - Persists required `issuePrefix`

- `aglit new "Title" [--status] [--priority] [--project <slug>]`
  - Creates issue Markdown file; prints key and path

- `aglit project new "Title" [--status] [--priority] [--slug <slug>]`
  - Creates project Markdown file; prints key and path

- `aglit list [--status] [--project <slug>] [--group none]`
  - Default: status-grouped board view
  - `--group none` prints flat list

- `aglit projects [--status]`
  - Prints projects list with derived issue counts

Optional:
- `aglit check` (scan files; validate schema/id/status/priority; verify UUIDv7; verify projectId references; report duplicates/parse errors)

## OpenCode Plugin Plan
- Remove all custom tools (`aglit_select/read/write/edit`) and focus logic.
- Keep protocol injection only:
  - Use `.aglit/issues/*.md` and `.aglit/projects/*.md` as canonical.
  - Use `bash` to run `aglit list/projects/new`.
  - Use file tools to edit issue/project Markdown directly.

## Testing Plan
- UUIDv7: version/variant bits and format
- Header parsing defaults (missing frontmatter/title)
- Board/list ordering with priority enum
- Project view counts derived from issue headers
- CLI `new` writes valid frontmatter + H1

## Rollout Steps
1) Update docs (`README.md`) to new format and commands.
2) Implement SDK core: UUIDv7 + frontmatter parsing + listing + rendering + creation.
3) Implement CLI: init/new/list/projects (+ optional check).
4) Simplify plugin to protocol-only.
5) Update tests; remove old JSON/ops tests.

## Decisions
- Project slug is derived from the title (kebab-case; if it already exists, suffix with `-2`, `-3`, ...; keep `--slug` as an escape hatch).
- Project `status` and `priority` mirror issues (same enums).
